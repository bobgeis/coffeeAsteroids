// Generated by CoffeeScript 1.10.0
(function() {
  "State\n\nVarious game states/modes/screens/views/etc.\neg: Preloader Screen, Splash Screen, Play Screen, etc.";
  var A, C, H, M, S, State, changeState, currentState, drawText, eng, getCtx, getModel, getPlayer, getState;

  S = {};

  _first.offer('state', S);

  A = _first.request('assets');

  C = _first.request('config');

  H = _first.request('helper');

  M = _first.request('model');

  eng = null;

  S.initStates = function(engine) {
    eng = engine;
    return eng.changeState(S.preload);
  };

  changeState = function(state) {
    return eng.changeState(state);
  };

  getPlayer = function() {
    return eng.player;
  };

  getModel = function() {
    return eng.model;
  };

  getState = function() {
    return eng.state;
  };

  getCtx = function() {
    return eng.ctx;
  };

  State = (function() {
    function State() {
      return;
    }

    State.prototype.enter = function() {
      return console.log("enter");
    };

    State.prototype.draw = function(ctx) {
      return console.log("draw " + ctx);
    };

    State.prototype.update = function(dt) {
      return false;
    };

    State.prototype.input = function(type, data) {
      return console.log("input: " + type + " " + data);
    };

    State.prototype.exit = function() {
      return console.log("exit");
    };

    return State;

  })();

  currentState = null;

  S.setState = function(state) {
    if (currentState) {
      currentState.exit();
    }
    state.enter();
    return currentState = state;
  };

  S.updateState = function(dt) {
    if (currentState) {
      return currentState.update(dt);
    }
  };

  S.preload = {
    enter: function() {
      console.log("enter preload");
      return A.loadAllImgs();
    },
    draw: function(ctx) {
      ctx.fillStyle = "#000000";
      ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      return drawText(ctx, "Loading", 30, ctx.canvas.width / 2, ctx.canvas.height / 2);
    },
    update: function(dt) {
      if (A.loadingFinished()) {
        A.afterLoad();
        return changeState(S.splash);
      }
    },
    input: function(type, data) {},
    exit: function() {
      return console.log("exit preload");
    }
  };

  S.splash = {
    y: 0,
    enter: function() {
      return console.log("enter splash");
    },
    draw: function(ctx) {
      var a, img;
      ctx.fillStyle = "#000000";
      ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      H.drawImg(ctx, A.img.bg.tile, ctx.canvas.width / 2, ctx.canvas.height / 2 + this.y);
      H.drawImg(ctx, A.img.bg.tile, ctx.canvas.width / 2, ctx.canvas.height / 2 + this.y - C.tileSize);
      img = A.img.ship.rayciv;
      a = H.HALFPI;
      H.drawImg(ctx, img, ctx.canvas.width / 2, ctx.canvas.height / 2, a);
      return drawText(ctx, "Press [Space] to start.", 15, ctx.canvas.width / 2, ctx.canvas.height / 2 + 200);
    },
    update: function(dt) {
      this.y = this.y + dt / 1.5;
      return this.y = this.y % C.tileSize;
    },
    input: function(type, data) {
      if (type === "keydown") {
        console.log(data.code);
        if (data.code === "Space") {
          return changeState(S.play);
        }
      }
    },
    exit: function() {
      return console.log("exit splash");
    }
  };

  S.play = {
    model: null,
    enter: function() {
      console.log("enter play");
      return this.model = new M.Model();
    },
    draw: function(ctx) {
      ctx.fillStyle = "#000000";
      ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      if (this.model) {
        return this.model.draw(ctx);
      }
    },
    update: function(dt) {
      if (this.model) {
        this.model.update(dt);
        if (this.model.gameOver) {
          return changeState(S.gameOver);
        }
      }
    },
    input: function(type, data) {
      if (type === "keydown") {
        if (data.code === "ArrowLeft") {
          return this.model.command(1);
        } else if (data.code === "ArrowRight") {
          return this.model.command(2);
        } else if (data.code === "ArrowUp") {
          return this.model.command(3);
        } else if (data.code === "ArrowDown") {
          return this.model.command(4);
        } else if (data.code === "Space") {
          return this.model.command(5);
        } else if (data.code === "KeyK") {
          return this.model.command(99);
        }
      } else if (type === "keyup") {
        if (data.code === "ArrowLeft") {
          return this.model.command(11);
        } else if (data.code === "ArrowRight") {
          return this.model.command(11);
        } else if (data.code === "ArrowUp") {
          return this.model.command(13);
        } else if (data.code === "ArrowDown") {
          return this.model.command(13);
        }
      }
    },
    exit: function() {
      return console.log("exit play");
    }
  };

  S.gameOver = {
    enter: function() {
      return console.log("enter gameOver");
    },
    draw: function(ctx) {
      S.play.draw(ctx);
      drawText(ctx, "You have died. So it goes.", 30, ctx.canvas.width / 2, ctx.canvas.height / 2 - 200);
      return drawText(ctx, "Press [Space] to restart.", 15, ctx.canvas.width / 2, ctx.canvas.height / 2 + 200);
    },
    update: function(dt) {
      return S.play.model.update(dt);
    },
    input: function(type, data) {
      if (type === "keydown") {
        if (data.code === "Space") {
          return changeState(S.splash);
        }
      }
    },
    exit: function() {
      return console.log("exit gameOver");
    }
  };

  drawText = function(ctx, text, size, x, y) {
    var w;
    ctx.fillStyle = "#FFFFFF";
    ctx.font = (Math.floor(size)) + "px Arial";
    w = Math.floor((ctx.measureText(text)).width / 2);
    return ctx.fillText(text, Math.floor(x) - w, Math.floor(y) - Math.floor(size));
  };

}).call(this);
